<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Casino Roulette</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2c003e);
            color: #ffd700;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(30, 30, 30, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.5);
            text-align: center;
        }
        h1 {
            text-align: center;
            text-shadow: 0 0 15px #ffd700, 0 0 5px #ff4500;
            font-size: 2em;
            margin-bottom: 20px;
        }
        h3 {
            margin: 15px 0;
            font-size: 1.5em;
            text-shadow: 0 0 10px #ffd700;
        }
        .request {
            padding: 15px;
            margin: 10px 0;
            background: #333;
            border: 2px solid #ffd700;
            border-radius: 10px;
            text-align: left;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        button {
            padding: 10px 20px;
            background: linear-gradient(45deg, #ffd700, #b8860b);
            color: #000;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            transition: transform 0.3s ease;
            font-size: 14px;
            text-shadow: 0 0 3px #fff;
        }
        button:hover {
            transform: scale(1.1);
        }
        #game-status, #online-players {
            font-size: 1.2em;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            text-shadow: 0 0 10px #ffd700;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Admin Dashboard üé∞</h1>
        <div id="game-status">Game Status: <span id="state">Betting</span> | Time Left: <span id="timeLeft">30s</span></div>
        <div id="online-players">Online Players: 0</div>
        <div id="deposit-requests"><h3>Deposit Requests</h3></div>
        <div id="withdraw-requests"><h3>Withdraw Requests</h3></div>
    </div>

    <script>
        const depositRequestsDiv = document.getElementById('deposit-requests');
        const withdrawRequestsDiv = document.getElementById('withdraw-requests');
        const stateSpan = document.getElementById('state');
        const timeLeftSpan = document.getElementById('timeLeft');
        const onlinePlayersDiv = document.getElementById('online-players');

        let bonusSlots = [];

        // Game Server Logic with Advanced Control
        function manageGameServer() {
            let gameData = JSON.parse(localStorage.getItem('gameData') || '{"state": "betting", "timeLeft": 30, "bets": {}, "onlinePlayers": 0, "bonusSlots": [], "isRunning": true, "gameVersion": "1.0"}');
            
            if (gameData.timeLeft > 0) {
                gameData.timeLeft--;
                if (gameData.state === 'betting' && gameData.timeLeft === 7) {
                    gameData.bonusSlots = generateBonusSlots();
                    bonusSlots = gameData.bonusSlots;
                }
            } else {
                if (gameData.state === 'betting') {
                    gameData.state = 'spinning';
                    gameData.finalAngle = Math.floor(Math.random() * 360);
                    gameData.timeLeft = 8;
                } else if (gameData.state === 'spinning') {
                    gameData.result = checkBallPosition(gameData.finalAngle);
                    gameData.state = 'result';
                    gameData.timeLeft = 2;
                    processWinnings(gameData.result);
                } else if (gameData.state === 'result') {
                    gameData.state = 'betting';
                    gameData.timeLeft = 30;
                    gameData.bets = {};
                    gameData.bonusSlots = [];
                    delete gameData.finalAngle;
                    delete gameData.result;
                }
            }
            gameData.onlinePlayers = JSON.parse(localStorage.getItem('onlinePlayers') || '0');
            gameData.isRunning = true;
            localStorage.setItem('gameData', JSON.stringify(gameData));
            stateSpan.textContent = gameData.state;
            timeLeftSpan.textContent = `${gameData.timeLeft}s`;
            onlinePlayersDiv.textContent = `Online Players: ${gameData.onlinePlayers}`;
        }

        function generateBonusSlots() {
            const bonusCount = Math.floor(Math.random() * 3) + 1;
            const bonusNumbers = new Set();
            while (bonusNumbers.size < bonusCount) {
                bonusNumbers.add(Math.floor(Math.random() * 36) + 1);
            }
            return Array.from(bonusNumbers).map(num => ({
                number: num,
                bonus: Math.floor(Math.random() * 451) + 50
            }));
        }

        function checkBallPosition(finalAngle) {
            const anglePerNumber = 360 / 36;
            const index = Math.floor(finalAngle / anglePerNumber);
            const number = (index % 36) + 1;
            const bonusData = bonusSlots.find(slot => slot.number === number);
            const bonus = bonusData ? bonusData.bonus : 0;
            return {
                number,
                isRed: index % 2 === 1,
                isBlack: index % 2 === 0,
                isOdd: number % 2 === 1,
                isEven: number % 2 === 0,
                isLow: number <= 18,
                isHigh: number > 18,
                dozen: number <= 12 ? '1st12' : number <= 24 ? '2nd12' : '3rd12',
                column: index % 3 === 0 ? 'col1' : index % 3 === 1 ? 'col2' : 'col3',
                bonus
            };
        }

        function processWinnings(result) {
            const bets = JSON.parse(localStorage.getItem('allBets') || '{}');
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '[]');
            Object.entries(bets).forEach(([area, amount]) => {
                let multiplier = 0;
                if (area === `${result.number}`) multiplier = 36 + (result.bonus || 0);
                else if (area === 'red' && result.isRed) multiplier = 2;
                else if (area === 'black' && result.isBlack) multiplier = 2;
                else if (area === 'odd' && result.isOdd) multiplier = 2;
                else if (area === 'even' && result.isEven) multiplier = 2;
                else if (area === '1-18' && result.isLow) multiplier = 2;
                else if (area === '19-36' && result.isHigh) multiplier = 2;
                else if (area === result.dozen) multiplier = 3;
                else if (area === result.column) multiplier = 3;
                if (multiplier > 0) {
                    userInfo.forEach(user => {
                        const userData = JSON.parse(localStorage.getItem('user_' + user.userId));
                        const userBet = userData.bets?.[area] || 0;
                        if (userBet > 0) {
                            const winnings = userBet * multiplier;
                            userData.balance += winnings;
                            delete userData.bets[area];
                            localStorage.setItem('user_' + user.userId, JSON.stringify(userData));
                            user.balance = userData.balance;
                        }
                    });
                }
            });
            localStorage.setItem('userInfo', JSON.stringify(userInfo));
            localStorage.setItem('allBets', '{}');
        }

        // Persistent Server Loop
        function startPersistentServer() {
            setInterval(() => {
                try {
                    manageGameServer();
                } catch (e) {
                    console.error('Server Error:', e);
                    alert('Admin Server ·Äê·ÄΩ·ÄÑ·Ä∫ ·Äï·Äº·Äø·Äî·Ä¨·Äõ·Äæ·Ä≠·Äî·Ä±·Äï·Ä´·Äê·Äö·Ä∫·Åã ·Äï·Äº·Äî·Ä∫·ÄÖ·Äô·Ä∫·Ä∏·ÄÄ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´!');
                }
            }, 1000);
        }

        function syncRequests() {
            setInterval(() => {
                try {
                    const requests = JSON.parse(localStorage.getItem('requests') || '{}');
                    depositRequestsDiv.innerHTML = '<h3>Deposit Requests</h3>';
                    withdrawRequestsDiv.innerHTML = '<h3>Withdraw Requests</h3>';
                    Object.entries(requests).forEach(([id, req]) => {
                        if (req.status === 'pending') {
                            const div = document.createElement('div');
                            div.className = 'request';
                            if (req.type === 'deposit') {
                                div.innerHTML = `
                                    User: ${req.userId.substr(0, 8)}... (Phone: ${req.phone})<br>
                                    Amount: ${req.amount} MMK<br>
                                    Transaction ID: ${req.transactionId}<br>
                                    <button onclick="approveRequest('${id}', 'deposit')">‚úÖ ·Äú·ÄÄ·Ä∫·ÄÅ·Ä∂</button>
                                    <button onclick="rejectRequest('${id}', 'deposit')">‚ùå ·ÄÑ·Äº·ÄÑ·Ä∫·Ä∏·Äï·Äö·Ä∫</button>
                                `;
                                depositRequestsDiv.appendChild(div);
                            } else if (req.type === 'withdraw') {
                                div.innerHTML = `
                                    User: ${req.userId.substr(0, 8)}... (Phone: ${req.phone})<br>
                                    Amount: ${req.amount} MMK<br>
                                    Method: ${req.method}<br>
                                    Phone: ${req.phone}<br>
                                    <button onclick="approveRequest('${id}', 'withdraw')">‚úÖ ·Äú·ÄÄ·Ä∫·ÄÅ·Ä∂</button>
                                    <button onclick="rejectRequest('${id}', 'withdraw')">‚ùå ·ÄÑ·Äº·ÄÑ·Ä∫·Ä∏·Äï·Äö·Ä∫</button>
                                `;
                                withdrawRequestsDiv.appendChild(div);
                            }
                        }
                    });
                } catch (e) {
                    console.error('Request Sync Error:', e);
                }
            }, 1000);
        }

        function approveRequest(id, type) {
            let requests = JSON.parse(localStorage.getItem('requests') || '{}');
            const req = requests[id];
            if (req) {
                if (type === 'deposit') {
                    const userData = JSON.parse(localStorage.getItem('user_' + req.userId));
                    userData.balance += req.amount;
                    localStorage.setItem('user_' + req.userId, JSON.stringify(userData));
                    updateUserInfo(req.userId, userData);
                }
                req.status = 'approved';
                localStorage.setItem('requests', JSON.stringify(requests));
            }
        }

        function rejectRequest(id, type) {
            let requests = JSON.parse(localStorage.getItem('requests') || '{}');
            const req = requests[id];
            if (req) {
                if (type === 'withdraw') {
                    const userData = JSON.parse(localStorage.getItem('user_' + req.userId));
                    userData.balance += req.amount;
                    localStorage.setItem('user_' + req.userId, JSON.stringify(userData));
                    updateUserInfo(req.userId, userData);
                }
                req.status = 'rejected';
                localStorage.setItem('requests', JSON.stringify(requests));
            }
        }

        function updateUserInfo(userId, userData) {
            let userInfo = JSON.parse(localStorage.getItem('userInfo') || '[]');
            const existingUserIndex = userInfo.findIndex(u => u.userId === userId);
            if (existingUserIndex !== -1) {
                userInfo[existingUserIndex] = { userId, phone: userData.phone, balance: userData.balance };
            }
            localStorage.setItem('userInfo', JSON.stringify(userInfo));
        }

        // Initialize
        startPersistentServer();
        syncRequests();

        // Error Handling
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            console.error('Admin Error:', msg, 'Line:', lineNo, 'Column:', columnNo, 'Details:', error);
            return false;
        };
    </script>
</body>
</html>
