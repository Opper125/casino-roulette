<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2c003e); 
            color: #ffd700; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 900px; 
            margin: auto; 
            background: rgba(30, 30, 30, 0.95); 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
            text-align: center; 
        }
        h1 { 
            text-shadow: 0 0 15px #ffd700; 
            font-size: 2em; 
            margin: 0; 
        }
        .request { 
            padding: 10px; 
            margin: 5px; 
            background: #333; 
            border: 2px solid #ffd700; 
            border-radius: 8px; 
            font-size: 14px; 
        }
        button { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold; 
        }
        input { 
            padding: 10px; 
            background: #222; 
            color: #ffd700; 
            border: 1px solid #ffd700; 
            border-radius: 5px; 
            margin: 5px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Admin Dashboard</h1>
        <div id="game-status">Game Status: <span id="state">Stopped</span> | Online Players: <span id="online-players">0</span></div>
        <button onclick="startGame()">‚ñ∂Ô∏è Start Games</button>
        <button onclick="stopGame()">‚èπÔ∏è Stop Games</button>
        <div id="deposit-control">
            <h3>·ÄÑ·ÄΩ·Ä±·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏</h3>
            <input type="text" id="deposit-phone" placeholder="·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫ (09xxxxxxxxx)">
            <input type="number" id="deposit-amount" placeholder="·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè (MMK)">
            <button onclick="submitAdminDeposit()">‚úîÔ∏è ·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äô·Ää·Ä∫</button>
        </div>
        <div id="withdraw-requests"><h3>Withdraw Requests</h3></div>
        <button onclick="window.open('user-info.html')">üë§ User Info</button>
    </div>

    <script>
        const BASE_URL = 'https://casino-opper.netlify.app'; // Your Netlify URL

        async function fetchData() {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, { cache: 'no-store' });
                if (!response.ok) throw new Error('Server ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´');
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                console.error('Fetch failed:', e);
                return JSON.parse(localStorage.getItem('offlineData') || '{}');
            }
        }

        async function updateData(updates) {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                if (!response.ok) throw new Error('Server ·Äû·Ä≠·ÄØ·Ä∑ ·Äí·Ä±·Äê·Ä¨·Äï·Ä≠·ÄØ·Ä∑·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´');
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                console.error('Update failed:', e);
                let localData = JSON.parse(localStorage.getItem('offlineData') || '{}');
                localData = { ...localData, ...updates };
                localStorage.setItem('offlineData', JSON.stringify(localData));
                return localData;
            }
        }

        function maskPhoneNumber(phone) {
            return phone.slice(0, -3).replace(/[0-9]/g, '*') + phone.slice(-3);
        }

        function manageGameServer() {
            setInterval(async () => {
                const data = await fetchData();
                document.getElementById('state').innerHTML = data.game && data.game.adminStarted ? 'Active' : 'Stopped';

                let onlineCount = 0;
                Object.values(data.users || {}).forEach(user => {
                    if (Date.now() - user.lastActive < 30000) onlineCount++; // Online if active in last 30s
                });
                document.getElementById('online-players').innerHTML = onlineCount;

                const requests = data.requests || {};
                const withdrawDiv = document.getElementById('withdraw-requests');
                withdrawDiv.innerHTML = '<h3>Withdraw Requests</h3>';
                Object.entries(requests).forEach(([id, req]) => {
                    if (req.status === 'pending' && req.type === 'withdraw') {
                        const div = document.createElement('div');
                        div.className = 'request';
                        div.innerHTML = `User: ${req.userId.substr(0, 8)}... (Phone: ${maskPhoneNumber(req.withdrawPhone)})<br>Amount: ${req.amount} MMK<br>
                            <button onclick="approveRequest('${id}')">‚úÖ</button><button onclick="rejectRequest('${id}')">‚ùå</button>`;
                        withdrawDiv.appendChild(div);
                    }
                });

                Object.keys(requests).forEach(id => {
                    if (requests[id].status !== 'pending') delete requests[id];
                });
                await updateData({ requests });
            }, 1000); // Poll every second
        }

        async function startGame() {
            const data = await fetchData();
            await updateData({ game: { adminStarted: true } });
            alert('·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·ÄÖ·Äê·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏');
        }

        async function stopGame() {
            const data = await fetchData();
            await updateData({ game: { adminStarted: false } });
            alert('·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·Äô·Äª·Ä¨·Ä∏ ·Äõ·Äï·Ä∫·Äê·Äî·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏');
        }

        async function approveRequest(id) {
            const data = await fetchData();
            const req = data.requests[id];
            if (!req || !data.users[req.userId]) return;
            data.transactions[req.userId] = data.transactions[req.userId] || [];
            const tx = data.transactions[req.userId].find(tx => tx.timestamp === req.timestamp);
            if (tx) tx.status = 'approved';
            req.status = 'approved';
            await updateData({ requests: data.requests, transactions: data.transactions });
        }

        async function rejectRequest(id) {
            const data = await fetchData();
            const req = data.requests[id];
            if (!req || !data.users[req.userId]) return;
            data.users[req.userId].balance += req.amount;
            data.transactions[req.userId] = data.transactions[req.userId] || [];
            const tx = data.transactions[req.userId].find(tx => tx.timestamp === req.timestamp);
            if (tx) tx.status = 'rejected';
            req.status = 'rejected';
            await updateData({ users: data.users, requests: data.requests, transactions: data.transactions });
        }

        async function submitAdminDeposit() {
            const phone = document.getElementById('deposit-phone').value;
            const amount = parseInt(document.getElementById('deposit-amount').value);
            if (!phone.match(/^09\d{8,9}$/) || amount < 100) {
                alert('·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè ·Äô·Äô·Äæ·Äî·Ä∫·Äï·Ä´');
                return;
            }
            const data = await fetchData();
            const userId = Object.entries(data.users || {}).find(([_, user]) => user.phone === phone)?.[0];
            if (!userId) {
                alert('·Äí·ÄÆ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫·Äî·Ä≤·Ä∑ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äõ·Äæ·Ä≠·Äï·Ä´');
                return;
            }
            data.users[userId].balance = (data.users[userId].balance || 0) + amount;
            data.users[userId].transactions = data.users[userId].transactions || [];
            data.users[userId].transactions.push({ type: 'deposit', amount, status: 'approved', timestamp: Date.now() });
            await updateData({ users: data.users });
            document.getElementById('deposit-phone').value = '';
            document.getElementById('deposit-amount').value = '';
            alert(`User ${phone} ·Äû·Ä≠·ÄØ·Ä∑ ${amount} MMK ·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏`);
        }

        window.onload = () => {
            manageGameServer();
        };
    </script>
</body>
</html>
