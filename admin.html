<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Casino Roulette</title>
    <style>
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #1a1a1a, #2c003e); color: #ffd700; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: rgba(30, 30, 30, 0.95); padding: 20px; border-radius: 15px; box-shadow: 0 0 30px rgba(255, 215, 0, 0.7); text-align: center; }
        h1 { text-shadow: 0 0 15px #ffd700; }
        .request { padding: 10px; margin: 5px; background: #333; border: 2px solid #ffd700; border-radius: 8px; }
        button { padding: 10px 20px; background: linear-gradient(45deg, #ffd700, #b8860b); color: #000; border: none; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: bold; transition: transform 0.2s; }
        button:hover { transform: scale(1.05); }
        .support-section { margin-top: 20px; background: #333; padding: 15px; border-radius: 10px; }
        .chat-box { background: #444; padding: 10px; margin: 5px; border-radius: 5px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎰 Admin Dashboard 🎰</h1>
        <div id="game-status">Game Status: <span id="state">Betting</span> | Time Left: <span id="timeLeft">30s</span></div>
        <div id="online-players">Online Players: 0</div>
        <div id="deposit-requests"><h3>Deposit Requests</h3></div>
        <div id="withdraw-requests"><h3>Withdraw Requests</h3></div>
        <div class="support-section">
            <h3>📞 Customer Support Messages</h3>
            <div id="support-messages"></div>
        </div>
        <button onclick="window.open('user-info.html')">👤 User Info</button>
        <button onclick="resetServer()">🔄 Reset Server</button>
    </div>

    <script>
        const REPO = 'casino-roulette';
        const OWNER = 'Opper125';
        const FILE_PATH = 'data.json';
        const BASE_URL = 'https://casino-opper.netlify.app';

        async function syncData(action, updates = {}) {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/sync`, {
                    method: 'POST',
                    body: JSON.stringify({ action, updates, repo: REPO, owner: OWNER, path: FILE_PATH })
                });
                if (!response.ok) throw new Error('Sync failed');
                return await response.json();
            } catch (error) {
                console.error('Sync Error:', error);
                return { users: {}, requests: {}, messages: [], game: { state: 'betting', timeLeft: 30, onlinePlayers: 0, result: null } };
            }
        }

        function manageGameServer() {
            setInterval(async () => {
                const data = await syncData('get');
                document.getElementById('state').innerHTML = data.game.state;
                document.getElementById('timeLeft').innerHTML = `${data.game.timeLeft}s`;
                document.getElementById('online-players').innerHTML = `Online Players: ${data.game.onlinePlayers || 0}`;

                const requests = data.requests || {};
                const depositDiv = document.getElementById('deposit-requests');
                const withdrawDiv = document.getElementById('withdraw-requests');
                depositDiv.innerHTML = '<h3>Deposit Requests</h3>';
                withdrawDiv.innerHTML = '<h3>Withdraw Requests</h3>';
                Object.entries(requests).forEach(([id, req]) => {
                    if (req.status === 'pending') {
                        const div = document.createElement('div');
                        div.className = 'request';
                        div.innerHTML = req.type === 'deposit' ?
                            `User: ${req.userId.substr(0, 8)}... (Phone: ${req.phone})<br>Amount: ${req.amount} MMK<br>Transaction ID: ${req.transactionId}<br>
                            <button onclick="approveRequest('${id}', 'deposit')">✅ လက်ခံ</button><button onclick="rejectRequest('${id}')">❌ ငြင်းပယ်</button>` :
                            `User: ${req.userId.substr(0, 8)}... (Phone: ${req.withdrawPhone})<br>Amount: ${req.amount} MMK<br>
                            <button onclick="approveRequest('${id}', 'withdraw')">✅ လက်ခံ</button><button onclick="rejectRequest('${id}')">❌ ငြင်းပယ်</button>`;
                        req.type === 'deposit' ? depositDiv.appendChild(div) : withdrawDiv.appendChild(div);
                    }
                });

                const messages = data.messages || [];
                const supportDiv = document.getElementById('support-messages');
                supportDiv.innerHTML = '';
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-box';
                    div.innerHTML = `<b>User ${msg.phone}:</b> ${msg.message} <br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
                    supportDiv.appendChild(div);
                });
            }, 1000);
        }

        async function approveRequest(id, type) {
            const data = await syncData('get');
            const req = data.requests[id];
            if (type === 'deposit') {
                data.users[req.userId].balance += req.amount;
            }
            req.status = 'approved';
            await syncData('set', data);
        }

        async function rejectRequest(id) {
            const data = await syncData('get');
            data.requests[id].status = 'rejected';
            await syncData('set', data);
        }

        async function resetServer() {
            await syncData('set', {
                users: {},
                requests: {},
                messages: [],
                game: { state: 'betting', timeLeft: 30, onlinePlayers: 0, result: null }
            });
            alert('Server အသစ်စတင်ပြီးပါပြီ။');
        }

        manageGameServer();
    </script>
</body>
</html>
