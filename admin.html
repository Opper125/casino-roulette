<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2c003e); 
            color: #ffd700; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 900px; 
            margin: auto; 
            background: rgba(30, 30, 30, 0.95); 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
            text-align: center; 
            animation: fadeIn 0.5s ease-in-out; 
        }
        h1 { 
            text-shadow: 0 0 15px #ffd700; 
            font-size: 2em; 
            margin: 0; 
            animation: glow 2s infinite alternate; 
        }
        .request { 
            padding: 10px; 
            margin: 5px; 
            background: #333; 
            border: 2px solid #ffd700; 
            border-radius: 8px; 
            font-size: 14px; 
        }
        button { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px; 
            font-weight: bold; 
            transition: transform 0.2s; 
        }
        button:hover { transform: scale(1.05); }
        .support-section { 
            margin-top: 20px; 
            background: #333; 
            padding: 15px; 
            border-radius: 10px; 
        }
        select, input { 
            padding: 10px; 
            background: #222; 
            color: #ffd700; 
            border: 1px solid #ffd700; 
            border-radius: 5px; 
            font-size: 14px; 
            margin: 5px; 
        }
        .support-user { 
            cursor: pointer; 
            padding: 10px; 
            background: #444; 
            margin: 5px; 
            border-radius: 5px; 
            font-size: 14px; 
            transition: background 0.2s; 
        }
        .support-user:hover { background: #666; }
        .chat-log { 
            max-height: 200px; 
            overflow-y: auto; 
            margin-top: 10px; 
            font-size: 14px; 
            background: #444; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .chat-message { 
            background: #555; 
            padding: 5px; 
            margin: 5px 0; 
            border-radius: 5px; 
            text-align: left; 
        }
        .chat-message.admin { background: #666; text-align: right; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glow { from { text-shadow: 0 0 10px #ffd700; } to { text-shadow: 0 0 20px #ffd700; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Admin Dashboard</h1>
        <div id="game-status">Game Status: <span id="state">Betting</span> | Time Left: <span id="timeLeft">30s</span></div>
        <div id="online-players">Online Players: 0</div>
        <div id="next-result">Next Spin Result: <span id="next-result-number">N/A</span></div>
        <button onclick="startGame()">‚ñ∂Ô∏è Start</button>
        <button onclick="stopGame()">‚èπÔ∏è Stop</button>
        <div id="result-control">
            <h3>·ÄÄ·Äª·Äï·Äî·Ä∫·Ä∏·Äõ·Äú·Äí·Ä∫</h3>
            <select id="result-number">
                <option value="">·ÄÄ·Äª·Äï·Äî·Ä∫·Ä∏</option>
                ${Array.from({ length: 37 }, (_, i) => `<option value="${i}">${i}</option>`).join('')}
            </select>
            <button onclick="setResult()">‚úîÔ∏è ·Ä°·Äê·Ää·Ä∫</button>
        </div>
        <div id="deposit-control">
            <h3>·ÄÑ·ÄΩ·Ä±·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏</h3>
            <input type="text" id="deposit-phone" placeholder="·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫ (09xxxxxxxxx)">
            <input type="number" id="deposit-amount" placeholder="·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè (MMK)">
            <button onclick="submitAdminDeposit()">‚úîÔ∏è ·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äô·Ää·Ä∫</button>
        </div>
        <div id="withdraw-requests"><h3>Withdraw Requests</h3></div>
        <div id="support-users">
            <h3>Customer Support</h3>
            <div id="user-list"></div>
            <div id="support-chat" style="display: none;">
                <h4>Chat with <span id="chat-user-id"></span></h4>
                <div class="chat-log" id="admin-chat-log"></div>
                <textarea id="admin-support-input" placeholder="·ÄÖ·Ä¨·Äï·Äº·Äî·Ä∫·Äõ·Ä±·Ä∏·Äï·Ä´..."></textarea>
                <button onclick="sendAdminSupportMessage()">üì© ·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∫</button>
            </div>
        </div>
        <button onclick="window.open('user-info.html')">üë§ User Info</button>
        <button onclick="resetServer()">üîÑ Reset</button>
    </div>

    <script src="sw.js"></script>
    <script>
        const BASE_URL = 'https://casino-opper.netlify.app';
        const WS_URL = 'wss://casino-opper.netlify.app/.netlify/functions/websocket';
        let socket, selectedUserId = null;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => console.log('Service Worker Registered'));
        }

        async function initWebSocket() {
            socket = new WebSocket(WS_URL);
            socket.onopen = () => console.log('WebSocket Connected');
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                manageGameServer(data);
            };
            socket.onclose = () => setTimeout(initWebSocket, 1000);
        }

        async function fetchData() {
            const response = await fetch(`${BASE_URL}/.netlify/functions/data`, { cache: 'no-store' });
            const data = await response.json();
            localStorage.setItem('offlineData', JSON.stringify(data));
            return data;
        }

        async function updateData(updates) {
            const response = await fetch(`${BASE_URL}/.netlify/functions/data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updates)
            });
            const data = await response.json();
            localStorage.setItem('offlineData', JSON.stringify(data));
            socket.send(JSON.stringify(updates));
            return data;
        }

        function manageGameServer(data) {
            document.getElementById('state').innerHTML = data.game.state;
            document.getElementById('timeLeft').innerHTML = `${data.game.timeLeft}s`;
            document.getElementById('online-players').innerHTML = `Online Players: ${Object.keys(data.users || {}).length}`;
            document.getElementById('next-result-number').innerHTML = data.game.nextResult !== null ? data.game.nextResult : 'N/A';

            const requests = data.requests || {};
            const withdrawDiv = document.getElementById('withdraw-requests');
            withdrawDiv.innerHTML = '<h3>Withdraw Requests</h3>';
            Object.entries(requests).forEach(([id, req]) => {
                if (req.status === 'pending' && req.type === 'withdraw') {
                    const div = document.createElement('div');
                    div.className = 'request';
                    div.innerHTML = `User: ${req.userId.substr(0, 8)}... (Phone: ${maskPhoneNumber(req.withdrawPhone)})<br>Amount: ${req.amount} MMK<br>
                        <button onclick="approveRequest('${id}', 'withdraw')">‚úÖ</button><button onclick="rejectRequest('${id}')">‚ùå</button>`;
                    withdrawDiv.appendChild(div);
                }
            });

            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            Object.entries(data.users || {}).forEach(([id, user]) => {
                const div = document.createElement('div');
                div.className = 'support-user';
                div.innerHTML = `User: ${id.substr(0, 8)}... (Phone: ${maskPhoneNumber(user.phone)}) | Balance: ${user.balance || 0} MMK
                    <input type="number" id="withdraw-${id}" placeholder="·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè (MMK)" style="width: 100px;">
                    <button onclick="submitAdminWithdraw('${id}')">üè¶ ·Äë·ÄØ·Äê·Ä∫·Äô·Ää·Ä∫</button>`;
                div.onclick = (e) => { if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') openSupportChat(id); };
                userList.appendChild(div);
            });
        }

        function maskPhoneNumber(phone) {
            return phone.slice(0, -3).replace(/[0-9]/g, '*') + phone.slice(-3);
        }

        async function startGame() {
            const data = await fetchData();
            await updateData({ game: { ...data.game, adminStarted: true } });
            alert('·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏');
        }

        async function stopGame() {
            const data = await fetchData();
            await updateData({ game: { ...data.game, adminStarted: false, state: 'betting', timeLeft: 30, result: null, nextResult: null } });
            alert('·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·Äõ·Äï·Ä∫·Äê·Äî·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏');
        }

        async function approveRequest(id, type) {
            const data = await fetchData();
            const req = data.requests[id];
            if (!req || !data.users[req.userId]) return;
            if (type === 'withdraw') {
                data.transactions[req.userId].find(tx => tx.timestamp === req.timestamp).status = 'approved';
                data.users[req.userId].messages.push({ from: 'admin', text: `·ÄÑ·ÄΩ·Ä±·Äë·ÄØ·Äê·Ä∫ ${req.amount} MMK ·Ä°·Äê·Ää·Ä∫`, timestamp: Date.now() });
            }
            req.status = 'approved';
            await updateData(data);
        }

        async function rejectRequest(id) {
            const data = await fetchData();
            const req = data.requests[id];
            if (!req || !data.users[req.userId]) return;
            if (req.type === 'withdraw') {
                data.users[req.userId].balance += req.amount;
                data.transactions[req.userId].find(tx => tx.timestamp === req.timestamp).status = 'rejected';
                data.users[req.userId].messages.push({ from: 'admin', text: `·ÄÑ·ÄΩ·Ä±·Äë·ÄØ·Äê·Ä∫ ${req.amount} MMK ·ÄÑ·Äº·ÄÑ·Ä∫·Ä∏·Äï·Äö·Ä∫`, timestamp: Date.now() });
            }
            req.status = 'rejected';
            await updateData(data);
        }

        async function setResult() {
            const result = parseInt(document.getElementById('result-number').value);
            if (isNaN(result)) return;
            const data = await fetchData();
            if (!data.game.adminStarted) {
                alert('·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÄ·Ä≠·ÄØ ·Ä°·Äõ·ÄÑ·Ä∫·ÄÖ·Äê·ÄÑ·Ä∫·Äï·Ä´');
                return;
            }
            await updateData({ game: { ...data.game, result } });
            alert(`Result set to ${result}`);
        }

        async function resetServer() {
            const data = await fetchData();
            await updateData({
                requests: {},
                messages: [],
                game: { state: 'betting', timeLeft: 30, onlinePlayers: Object.keys(data.users || {}).length, result: null, adminStarted: false, history: [], nextResult: null },
                transactions: {}
            });
            alert('Server ·Ä°·Äû·ÄÖ·Ä∫·ÄÖ·Äê·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏');
        }

        async function submitAdminDeposit() {
            const phone = document.getElementById('deposit-phone').value;
            const amount = parseInt(document.getElementById('deposit-amount').value);
            if (!phone.match(/^09\d{8,9}$/) || amount < 100) {
                alert('·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ ·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè ·Äô·Äô·Äæ·Äî·Ä∫·Äï·Ä´');
                return;
            }
            const data = await fetchData();
            const userId = Object.entries(data.users || {}).find(([_, user]) => user.phone === phone)?.[0];
            if (!userId) {
                alert('·Äí·ÄÆ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫·Äî·Ä≤·Ä∑ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äô·Äõ·Äæ·Ä≠·Äï·Ä´');
                return;
            }
            const users = data.users || {};
            users[userId].balance = (users[userId].balance || 0) + amount;
            users[userId].transactions = users[userId].transactions || [];
            users[userId].transactions.push({ type: 'deposit', amount, status: 'approved', timestamp: Date.now() });
            users[userId].messages.push({ from: 'admin', text: `·ÄÑ·ÄΩ·Ä±·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏ ${amount} MMK ·Ä°·Äê·Ää·Ä∫`, timestamp: Date.now() });
            await updateData({ users });
            document.getElementById('deposit-phone').value = '';
            document.getElementById('deposit-amount').value = '';
            alert(`User ${phone} ·Äû·Ä≠·ÄØ·Ä∑ ${amount} MMK ·Äû·ÄΩ·ÄÑ·Ä∫·Ä∏·Äï·Äº·ÄÆ·Ä∏`);
        }

        async function submitAdminWithdraw(userId) {
            const amount = parseInt(document.getElementById(`withdraw-${userId}`).value);
            if (!amount || amount < 100) {
                alert('·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè ·Äô·Äô·Äæ·Äî·Ä∫·Äï·Ä´');
                return;
            }
            const data = await fetchData();
            const user = data.users[userId];
            if (!user || user.balance < amount) {
                alert('·Äú·ÄÄ·Ä∫·ÄÄ·Äª·Äî·Ä∫·ÄÑ·ÄΩ·Ä± ·Äô·Äú·ÄØ·Ä∂·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´');
                return;
            }
            user.balance -= amount;
            user.transactions = user.transactions || [];
            user.transactions.push({ type: 'withdraw', amount, status: 'approved', timestamp: Date.now() });
            user.messages.push({ from: 'admin', text: `·ÄÑ·ÄΩ·Ä±·Äë·ÄØ·Äê·Ä∫ ${amount} MMK ·Ä°·Äê·Ää·Ä∫`, timestamp: Date.now() });
            data.users[userId] = user;
            await updateData({ users: data.users });
            document.getElementById(`withdraw-${userId}`).value = '';
            alert(`User ${maskPhoneNumber(user.phone)} ·Äô·Äæ ${amount} MMK ·Äë·ÄØ·Äê·Ä∫·Äï·Äº·ÄÆ·Ä∏`);
        }

        function openSupportChat(userId) {
            selectedUserId = userId;
            document.getElementById('support-chat').style.display = 'block';
            document.getElementById('chat-user-id').innerHTML = userId.substr(0, 8) + '...';
            updateAdminChatLog();
        }

        async function sendAdminSupportMessage() {
            const message = document.getElementById('admin-support-input').value;
            if (!message || !selectedUserId) return;
            const data = await fetchData();
            data.users[selectedUserId].messages = data.users[selectedUserId].messages || [];
            data.users[selectedUserId].messages.push({ from: 'admin', text: message, timestamp: Date.now() });
            await updateData(data);
            document.getElementById('admin-support-input').value = '';
            updateAdminChatLog();
        }

        function updateAdminChatLog() {
            fetchData().then(data => {
                const userMessages = data.users[selectedUserId]?.messages || [];
                const chatLog = document.getElementById('admin-chat-log');
                chatLog.innerHTML = '';
                userMessages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `chat-message ${msg.from === 'admin' ? 'admin' : ''}`;
                    div.innerHTML = `${msg.text}`;
                    chatLog.appendChild(div);
                });
                chatLog.scrollTop = chatLog.scrollHeight;
            });
        }

        window.onload = () => {
            initWebSocket();
            setInterval(() => fetchData().then(manageGameServer), 1000);
        };
    </script>
</body>
</html>
