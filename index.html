<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Home</title>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2c003e); 
            color: #ffd700; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            padding: 20px; 
            background: rgba(30, 30, 30, 0.95); 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
            text-align: center; 
        }
        h1 { 
            text-shadow: 0 0 15px #ffd700; 
            font-size: 2.5em; 
            margin: 0; 
        }
        .profile-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: #333; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .profile-info { font-size: 1.2em; }
        .game-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .game-card { 
            padding: 20px; 
            background: linear-gradient(45deg, #444, #666); 
            border-radius: 10px; 
            text-align: center; 
        }
        .game-card img { 
            width: 100%; 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }
        input { 
            width: 100%; 
            padding: 10px; 
            margin: 10px 0; 
            background: #222; 
            color: #ffd700; 
            border: 1px solid #ffd700; 
            border-radius: 8px; 
            font-size: 1em; 
        }
        button { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px; 
        }
        #login-result, #game-result { margin-top: 10px; }
        #roulette-wheel { margin: 20px auto; }
        .bet-table { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); 
            gap: 5px; 
            margin: 15px 0; 
        }
        .bet-area { 
            padding: 10px; 
            background: #444; 
            border: 2px solid #ffd700; 
            border-radius: 8px; 
            cursor: pointer; 
        }
        .bet-area:hover { background: #666; }
        .chip { 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            margin: 5px; 
        }
        .chip.active { border: 3px solid #fff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Casino Hub</h1>
        <div class="profile-bar" id="profile-bar" style="display: none;">
            <div class="profile-info">
                Phone: <span id="user-phone">Not Logged In</span> | 
                Balance: <span id="user-balance">0</span> MMK
            </div>
            <div>
                <button onclick="showWithdrawModal()">üè¶ Withdraw</button>
                <button onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        <div id="login-section">
            <h2>üéÆ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äù·ÄÑ·Ä∫·Äõ·Äî·Ä∫</h2>
            <input type="text" id="phone" placeholder="·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫ (09xxxxxxxxx)">
            <input type="password" id="pin" placeholder="PIN (6 ·Äú·ÄØ·Ä∂·Ä∏)">
            <button onclick="login()">·Äù·ÄÑ·Ä∫·Äô·Ää·Ä∫</button>
            <div id="login-result"></div>
        </div>
        <div id="game-section" style="display: none;">
            <div id="status">Game Status: <span id="game-status">Waiting for Admin...</span></div>
            <div class="game-grid">
                <div class="game-card">
                    <img src="https://via.placeholder.com/200x150?text=Roulette" alt="Roulette">
                    <h3>Roulette</h3>
                    <div id="roulette-wheel"><canvas id="wheel" width="200" height="200"></canvas></div>
                    <div class="bet-table" id="betTable"></div>
                    <div class="bet-chips">
                        <div class="chip" data-value="1000" onclick="selectChip(1000)">1K</div>
                        <div class="chip" data-value="10000" onclick="selectChip(10000)">10K</div>
                        <div class="chip" data-value="100000" onclick="selectChip(100000)">100K</div>
                    </div>
                    <button onclick="spinRoulette()">Spin</button>
                    <div id="roulette-result"></div>
                </div>
                <div class="game-card">
                    <img src="https://via.placeholder.com/200x150?text=Slots" alt="Slots">
                    <h3>Slots</h3>
                    <button onclick="spinSlots()">Spin (100 MMK)</button>
                    <div id="slots-result">·ÄÄ·ÄÖ·Ä¨·Ä∏·Äõ·Äî·Ä∫ Spin ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´!</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="withdrawModal" style="display: none;">
        <div class="modal-content" style="background: #1e1e1e; padding: 20px; border-radius: 10px; color: #ffd700;">
            <h2>üè¶ Withdraw</h2>
            <input type="text" id="withdraw-phone" placeholder="Kpay/Wave ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫">
            <input type="number" id="withdraw-amount" placeholder="·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè (MMK)">
            <button onclick="submitWithdraw()">·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äô·Ää·Ä∫</button>
            <button onclick="closeModal('withdrawModal')">‚ùå ·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫</button>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://casino-opper.netlify.app'; // Your Netlify URL
        let userId, balance = 0, bets = {}, selectedChip = null;

        async function fetchData() {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, { cache: 'no-store' });
                if (!response.ok) throw new Error('Server ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´');
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                console.error('Fetch failed:', e);
                return JSON.parse(localStorage.getItem('offlineData') || '{}');
            }
        }

        async function updateData(updates) {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                if (!response.ok) throw new Error('Server ·Äû·Ä≠·ÄØ·Ä∑ ·Äí·Ä±·Äê·Ä¨·Äï·Ä≠·ÄØ·Ä∑·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´');
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                console.error('Update failed:', e);
                let localData = JSON.parse(localStorage.getItem('offlineData') || '{}');
                localData = { ...localData, ...updates };
                localStorage.setItem('offlineData', JSON.stringify(localData));
                return localData;
            }
        }

        function maskPhoneNumber(phone) {
            return phone.slice(0, -3).replace(/[0-9]/g, '*') + phone.slice(-3);
        }

        async function login() {
            const phone = document.getElementById('phone').value;
            const pin = document.getElementById('pin').value;
            const resultDiv = document.getElementById('login-result');
            if (!phone.match(/^09\d{8,9}$/) || pin.length !== 6) {
                resultDiv.innerHTML = "‚ùå ·Äñ·ÄØ·Äî·Ä∫·Ä∏ ·Äû·Ä≠·ÄØ·Ä∑·Äô·Äü·ÄØ·Äê·Ä∫ PIN ·Äô·Äô·Äæ·Äî·Ä∫·Äï·Ä´!";
                return;
            }
            resultDiv.innerHTML = "‚è≥ ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫...";
            userId = btoa(phone + pin);
            try {
                const data = await fetchData();
                let users = data.users || {};
                if (!users[userId]) {
                    users[userId] = { 
                        phone, 
                        pin, 
                        balance: 0, 
                        totalWinnings: 0, 
                        transactions: [], 
                        createdAt: Date.now(), 
                        lastActive: Date.now(), 
                        warnings: 0, 
                        banUntil: 0 
                    };
                    resultDiv.innerHTML = "‚úÖ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Ä°·Äû·ÄÖ·Ä∫·Äñ·ÄΩ·ÄÑ·Ä∑·Ä∫·Äï·Äº·ÄÆ·Ä∏!";
                } else if (users[userId].pin === pin) {
                    resultDiv.innerHTML = "‚úÖ ·Ä°·ÄÄ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äù·ÄÑ·Ä∫·Äï·Äº·ÄÆ·Ä∏!";
                } else {
                    resultDiv.innerHTML = "‚ùå PIN ·Äô·Äô·Äæ·Äî·Ä∫·Äï·Ä´!";
                    return;
                }
                users[userId].lastActive = Date.now();
                await updateData({ users });
                localStorage.setItem('loggedInUser', userId);
                localStorage.setItem('phone', phone);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('profile-bar').style.display = 'flex';
                document.getElementById('game-section').style.display = 'block';
                setupBetTable();
                updateUI();
            } catch (e) {
                resultDiv.innerHTML = `‚ùå ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´: ${e.message}`;
            }
        }

        async function updateUI() {
            const data = await fetchData();
            userId = localStorage.getItem('loggedInUser');
            if (!userId || !data.users || !data.users[userId]) {
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('profile-bar').style.display = 'none';
                document.getElementById('game-section').style.display = 'none';
                return;
            }
            const user = data.users[userId];
            balance = user.balance || 0;
            document.getElementById('user-phone').innerHTML = maskPhoneNumber(user.phone);
            document.getElementById('user-balance').innerHTML = balance;
            document.getElementById('game-status').innerHTML = data.game && data.game.adminStarted ? 'Active' : 'Waiting for Admin...';
            user.lastActive = Date.now();
            await updateData({ users: data.users });
            setTimeout(updateUI, 1000); // Poll every second
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('phone');
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('profile-bar').style.display = 'none';
            document.getElementById('game-section').style.display = 'none';
        }

        function showWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function submitWithdraw() {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const withdrawPhone = document.getElementById('withdraw-phone').value;
            const data = await fetchData();
            if (!data.users[userId] || amount < 100 || amount > data.users[userId].balance || !withdrawPhone) {
                alert('·Äô·Äô·Äæ·Äî·Ä∫·ÄÄ·Äî·Ä∫·Äû·Ä±·Ä¨ ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äô·Äæ·ÄØ!');
                return;
            }
            data.users[userId].balance -= amount;
            const requestId = `${userId}_${Date.now()}`;
            data.requests = data.requests || {};
            data.requests[requestId] = { userId, phone: data.users[userId].phone, amount, withdrawPhone, type: 'withdraw', status: 'pending', timestamp: Date.now() };
            data.users[userId].transactions.push({ type: 'withdraw', amount, status: 'pending', timestamp: Date.now() });
            await updateData({ users: data.users, requests: data.requests });
            closeModal('withdrawModal');
            updateUI();
        }

        // Roulette Game Logic
        function setupBetTable() {
            const table = [...Array.from({ length: 37 }, (_, i) => i)];
            table.forEach(id => {
                const div = document.createElement('div');
                div.className = 'bet-area';
                div.id = `bet-${id}`;
                div.innerHTML = id;
                div.onclick = () => placeBet(id);
                document.getElementById('betTable').appendChild(div);
            });
        }

        function selectChip(value) {
            selectedChip = value;
            document.querySelectorAll('.chip').forEach(chip => {
                chip.classList.remove('active');
                if (parseInt(chip.dataset.value) === value) chip.classList.add('active');
            });
        }

        async function placeBet(id) {
            if (!selectedChip || balance < selectedChip) return;
            const data = await fetchData();
            if (!data.game || !data.game.adminStarted) {
                document.getElementById('roulette-result').innerHTML = "‚è≥ Admin ·Äô·Äæ ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´...";
                return;
            }
            const user = data.users[userId];
            if (!user || user.balance < selectedChip) return;
            user.balance -= selectedChip;
            bets[id] = (bets[id] || 0) + selectedChip;
            user.bets = bets;
            balance = user.balance;
            data.users[userId] = user;
            data.users[userId].transactions.push({ type: 'bet', game: 'roulette', amount: selectedChip, timestamp: Date.now() });
            await updateData({ users: data.users });
            updateBetTable();
        }

        function updateBetTable() {
            const table = document.getElementById('betTable').children;
            Array.from(table).forEach(area => {
                const id = area.id.replace('bet-', '');
                const amount = bets[id] || 0;
                area.innerHTML = `${id}${amount > 0 ? ` (${amount})` : ''}`;
            });
        }

        async function spinRoulette() {
            const data = await fetchData();
            if (!data.game || !data.game.adminStarted) {
                document.getElementById('roulette-result').innerHTML = "‚è≥ Admin ·Äô·Äæ ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´...";
                return;
            }
            const user = data.users[userId];
            if (!user || Object.keys(bets).length === 0) {
                document.getElementById('roulette-result').innerHTML = "üé≤ Bet ·Äê·ÄÑ·Ä∫·Äï·Ä´!";
                return;
            }
            const result = Math.floor(Math.random() * 37);
            drawWheel(result);
            let winnings = 0;
            if (bets[result]) winnings = bets[result] * 36;
            user.balance += winnings;
            user.totalWinnings = (user.totalWinnings || 0) + winnings;
            user.transactions.push({ type: 'win', game: 'roulette', amount: winnings, timestamp: Date.now() });
            bets = {};
            data.users[userId] = user;
            await updateData({ users: data.users });
            document.getElementById('roulette-result').innerHTML = winnings ? `üéâ ·Ä°·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ: ${winnings} MMK` : 'üò¢ ·Ä°·Äõ·Äæ·ÄØ·Ä∂·Ä∏·Äï·Ä´';
            updateUI();
        }

        function drawWheel(result) {
            const canvas = document.getElementById('wheel');
            const ctx = canvas.getContext('2d');
            const radius = canvas.width / 2;
            const numbers = Array.from({ length: 37 }, (_, i) => i);
            const colors = numbers.map(num => num === 0 ? '#00ff00' : (num % 2 === 0 ? '#ff0000' : '#000000'));

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(radius, radius);

            numbers.forEach((num, i) => {
                const angle = (i * 360 / 37) * Math.PI / 180;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, radius, angle, angle + (360 / 37) * Math.PI / 180);
                ctx.fillStyle = colors[i];
                ctx.fill();
                ctx.strokeStyle = '#ffd700';
                ctx.stroke();
                ctx.save();
                ctx.rotate(angle + (360 / 37 / 2) * Math.PI / 180);
                ctx.fillStyle = '#fff';
                ctx.font = '10px Poppins';
                ctx.fillText(num, radius - 20, 5);
                ctx.restore();
            });

            if (result !== null) {
                ctx.rotate((result * 360 / 37) * Math.PI / 180);
            }
            ctx.restore();
        }

        // Slots Game Logic
        async function spinSlots() {
            const data = await fetchData();
            if (!data.game || !data.game.adminStarted) {
                document.getElementById('slots-result').innerHTML = "‚è≥ Admin ·Äô·Äæ ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´...";
                return;
            }
            const user = data.users[userId];
            const bet = 100;
            if (!user || user.balance < bet) {
                document.getElementById('slots-result').innerHTML = '·ÄÑ·ÄΩ·Ä±·Äô·Äú·ÄØ·Ä∂·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´!';
                return;
            }
            user.balance -= bet;
            const result = Math.random() < 0.3 ? bet * 2 : 0; // 30% chance to win
            user.balance += result;
            user.totalWinnings = (user.totalWinnings || 0) + result;
            user.transactions.push({ type: 'bet', game: 'slots', amount: bet, timestamp: Date.now() });
            if (result > 0) user.transactions.push({ type: 'win', game: 'slots', amount: result, timestamp: Date.now() });
            await updateData({ users: data.users });
            document.getElementById('slots-result').innerHTML = result > 0 ? `·Ä°·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ: ${result} MMK!` : '·Ä°·Äõ·Äæ·ÄØ·Ä∂·Ä∏·Äï·Ä´!';
            updateUI();
        }

        window.onload = () => {
            updateUI();
        };
    </script>
</body>
</html>
