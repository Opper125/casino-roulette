<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Home</title>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2c003e); 
            color: #ffd700; 
            margin: 0; 
            padding: 20px; 
            overflow-x: hidden; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            padding: 20px; 
            background: rgba(30, 30, 30, 0.95); 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
            animation: fadeIn 0.5s ease-in-out; 
        }
        h1 { 
            text-shadow: 0 0 15px #ffd700; 
            font-size: 2.5em; 
            margin: 0; 
            text-align: center; 
            animation: glow 2s infinite alternate; 
        }
        .profile-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: #333; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); 
        }
        .profile-info { font-size: 1.2em; }
        .game-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .game-card { 
            padding: 20px; 
            background: linear-gradient(45deg, #444, #666); 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.3s, box-shadow 0.3s; 
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); 
        }
        .game-card:hover { 
            transform: scale(1.05); 
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); 
        }
        .game-card img { 
            width: 100%; 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }
        button { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: transform 0.2s; 
        }
        button:hover { transform: scale(1.05); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes glow { from { text-shadow: 0 0 10px #ffd700; } to { text-shadow: 0 0 20px #ffd700; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Casino Hub</h1>
        <div class="profile-bar" id="profile-bar">
            <div class="profile-info">
                Phone: <span id="user-phone">Not Logged In</span> | 
                Balance: <span id="user-balance">0</span> MMK
            </div>
            <div>
                <button onclick="showWithdrawModal()">üè¶ Withdraw</button>
                <button onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        <div class="game-grid" id="game-grid">
            <div class="game-card" onclick="window.location.href='roulette.html'">
                <img src="https://via.placeholder.com/200x150?text=Roulette" alt="Roulette">
                <h3>Roulette</h3>
            </div>
            <!-- Additional games will be dynamically added here -->
        </div>
    </div>

    <div class="modal" id="withdrawModal" style="display: none;">
        <div class="modal-content">
            <h2>üè¶ Withdraw</h2>
            <input type="text" id="withdraw-phone" placeholder="Kpay/Wave ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫">
            <input type="number" id="withdraw-amount" placeholder="·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè (MMK)">
            <button onclick="submitWithdraw()">·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äô·Ää·Ä∫</button>
            <button onclick="closeModal('withdrawModal')">‚ùå ·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫</button>
        </div>
    </div>

    <script src="sw.js"></script>
    <script>
        const BASE_URL = 'https://casino-opper.netlify.app';
        const WS_URL = 'wss://casino-opper.netlify.app/.netlify/functions/websocket';
        let socket;

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => console.log('Service Worker Registered'));
        }

        async function initWebSocket() {
            socket = new WebSocket(WS_URL);
            socket.onopen = () => console.log('WebSocket Connected');
            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                updateUI(data);
            };
            socket.onclose = () => setTimeout(initWebSocket, 1000);
        }

        async function fetchData() {
            const response = await fetch(`${BASE_URL}/.netlify/functions/data`, { cache: 'no-store' });
            const data = await response.json();
            localStorage.setItem('offlineData', JSON.stringify(data));
            return data;
        }

        async function updateData(updates) {
            if (navigator.onLine) {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                socket.send(JSON.stringify(updates));
                return data;
            } else {
                let localData = JSON.parse(localStorage.getItem('offlineData') || '{}');
                localData = { ...localData, ...updates };
                localStorage.setItem('offlineData', JSON.stringify(localData));
                return localData;
            }
        }

        function updateUI(data) {
            const userId = localStorage.getItem('loggedInUser');
            if (userId && data.users[userId]) {
                document.getElementById('user-phone').innerHTML = maskPhoneNumber(data.users[userId].phone);
                document.getElementById('user-balance').innerHTML = data.users[userId].balance || 0;
            }
        }

        function maskPhoneNumber(phone) {
            return phone.slice(0, -3).replace(/[0-9]/g, '*') + phone.slice(-3);
        }

        async function checkLoggedIn() {
            const userId = localStorage.getItem('loggedInUser');
            if (userId) {
                const data = await fetchData();
                updateUI(data);
            } else {
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            window.location.reload();
        }

        function showWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function submitWithdraw() {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const withdrawPhone = document.getElementById('withdraw-phone').value;
            const userId = localStorage.getItem('loggedInUser');
            const data = await fetchData();
            if (amount < 100 || amount > data.users[userId].balance || !withdrawPhone) return;
            data.users[userId].balance -= amount;
            const requestId = `${userId}_${Date.now()}`;
            data.requests[requestId] = { userId, phone: data.users[userId].phone, amount, withdrawPhone, type: 'withdraw', status: 'pending', timestamp: Date.now() };
            await updateData({ users: data.users, requests: data.requests });
            closeModal('withdrawModal');
            updateUI(data);
        }

        window.onload = () => {
            checkLoggedIn();
            initWebSocket();
        };
    </script>
</body>
</html>
