<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Home</title>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2c003e); 
            color: #ffd700; 
            margin: 0; 
            padding: 20px; 
            overflow-x: hidden; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
            padding: 20px; 
            background: rgba(30, 30, 30, 0.95); 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
        }
        h1 { 
            text-shadow: 0 0 15px #ffd700; 
            font-size: 2.5em; 
            margin: 0; 
            text-align: center; 
        }
        .profile-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px; 
            background: #333; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .profile-info { font-size: 1.2em; }
        .game-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .game-card { 
            padding: 20px; 
            background: linear-gradient(45deg, #444, #666); 
            border-radius: 10px; 
            text-align: center; 
            cursor: pointer; 
            transition: transform 0.3s; 
        }
        .game-card:hover { 
            transform: scale(1.05); 
        }
        .game-card img { 
            width: 100%; 
            border-radius: 8px; 
            margin-bottom: 10px; 
        }
        button { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∞ Casino Hub</h1>
        <div class="profile-bar" id="profile-bar">
            <div class="profile-info">
                Phone: <span id="user-phone">Not Logged In</span> | 
                Balance: <span id="user-balance">0</span> MMK
            </div>
            <div>
                <button onclick="showWithdrawModal()">üè¶ Withdraw</button>
                <button onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        <div id="status">Game Status: <span id="game-status">Waiting for Admin...</span></div>
        <div class="game-grid" id="game-grid">
            <div class="game-card" onclick="enterGame('roulette.html')">
                <img src="https://via.placeholder.com/200x150?text=Roulette" alt="Roulette">
                <h3>Roulette</h3>
            </div>
            <div class="game-card" onclick="enterGame('slots.html')">
                <img src="https://via.placeholder.com/200x150?text=Slots" alt="Slots">
                <h3>Slots</h3>
            </div>
        </div>
    </div>

    <div class="modal" id="withdrawModal" style="display: none;">
        <div class="modal-content" style="background: #1e1e1e; padding: 20px; border-radius: 10px; color: #ffd700;">
            <h2>üè¶ Withdraw</h2>
            <input type="text" id="withdraw-phone" placeholder="Kpay/Wave ·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Äê·Ä∫">
            <input type="number" id="withdraw-amount" placeholder="·ÄÑ·ÄΩ·Ä±·Äï·Äô·Ä¨·Äè (MMK)">
            <button onclick="submitWithdraw()">·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äô·Ää·Ä∫</button>
            <button onclick="closeModal('withdrawModal')">‚ùå ·Äï·Ä≠·Äê·Ä∫·Äô·Ää·Ä∫</button>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://casino-opper.netlify.app'; // Your Netlify URL
        let userId;

        async function fetchData() {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, { cache: 'no-store' });
                if (!response.ok) throw new Error('Server ·ÄÅ·Äª·Ä≠·Äê·Ä∫·ÄÜ·ÄÄ·Ä∫·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´');
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                console.error('Fetch failed:', e);
                return JSON.parse(localStorage.getItem('offlineData') || '{}');
            }
        }

        async function updateData(updates) {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                if (!response.ok) throw new Error('Server ·Äû·Ä≠·ÄØ·Ä∑ ·Äí·Ä±·Äê·Ä¨·Äï·Ä≠·ÄØ·Ä∑·Äô·Äæ·ÄØ ·Äô·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´');
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                console.error('Update failed:', e);
                let localData = JSON.parse(localStorage.getItem('offlineData') || '{}');
                localData = { ...localData, ...updates };
                localStorage.setItem('offlineData', JSON.stringify(localData));
                return localData;
            }
        }

        function maskPhoneNumber(phone) {
            return phone.slice(0, -3).replace(/[0-9]/g, '*') + phone.slice(-3);
        }

        async function updateUI() {
            const data = await fetchData();
            userId = localStorage.getItem('loggedInUser');
            if (!userId || !data.users || !data.users[userId]) {
                window.location.href = 'login.html';
                return;
            }
            const user = data.users[userId];
            document.getElementById('user-phone').innerHTML = maskPhoneNumber(user.phone);
            document.getElementById('user-balance').innerHTML = user.balance || 0;
            document.getElementById('game-status').innerHTML = data.game && data.game.adminStarted ? 'Active' : 'Waiting for Admin...';
            user.lastActive = Date.now();
            await updateData({ users: data.users });
        }

        async function checkLoggedIn() {
            userId = localStorage.getItem('loggedInUser');
            if (!userId) {
                window.location.href = 'login.html';
                return;
            }
            await updateUI();
            setInterval(updateUI, 1000); // Poll every second
        }

        function logout() {
            localStorage.removeItem('loggedInUser');
            localStorage.removeItem('phone');
            window.location.href = 'login.html';
        }

        function showWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'flex';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        async function submitWithdraw() {
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const withdrawPhone = document.getElementById('withdraw-phone').value;
            const data = await fetchData();
            if (!data.users[userId] || amount < 100 || amount > data.users[userId].balance || !withdrawPhone) {
                alert('·Äô·Äô·Äæ·Äî·Ä∫·ÄÄ·Äî·Ä∫·Äû·Ä±·Ä¨ ·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏·ÄÜ·Ä≠·ÄØ·Äô·Äæ·ÄØ!');
                return;
            }
            data.users[userId].balance -= amount;
            const requestId = `${userId}_${Date.now()}`;
            data.requests = data.requests || {};
            data.requests[requestId] = { userId, phone: data.users[userId].phone, amount, withdrawPhone, type: 'withdraw', status: 'pending', timestamp: Date.now() };
            data.users[userId].transactions = data.users[userId].transactions || [];
            data.users[userId].transactions.push({ type: 'withdraw', amount, status: 'pending', timestamp: Date.now() });
            await updateData({ users: data.users, requests: data.requests });
            closeModal('withdrawModal');
            updateUI();
        }

        async function enterGame(gameUrl) {
            const data = await fetchData();
            if (!data.game || !data.game.adminStarted) {
                alert('Admin ·Äô·Äæ ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´!');
                return;
            }
            window.location.href = gameUrl;
        }

        window.onload = () => {
            checkLoggedIn();
        };
    </script>
</body>
</html>
