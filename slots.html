<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slots</title>
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1a1a1a, #2c003e); 
            color: #ffd700; 
            margin: 0; 
            padding: 20px; 
        }
        .game-container { 
            max-width: 600px; 
            margin: auto; 
            background: rgba(30, 30, 30, 0.95); 
            padding: 20px; 
            border-radius: 15px; 
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.6); 
            text-align: center; 
        }
        h1 { 
            text-shadow: 0 0 15px #ffd700; 
            font-size: 2em; 
            margin: 0; 
        }
        button { 
            padding: 10px 20px; 
            background: linear-gradient(45deg, #ffd700, #b8860b); 
            color: #000; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            margin: 5px; 
        }
        #slot-result { font-size: 1.5em; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üé∞ Slots ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏</h1>
        <div id="online-players">Online Players: 0</div>
        <div>Balance: <span id="balance">0</span> MMK</div>
        <button onclick="spin()">Spin (100 MMK)</button>
        <button onclick="window.location.href='index.html'">üè† Back to Home</button>
        <div id="slot-result">·ÄÄ·ÄÖ·Ä¨·Ä∏·Äõ·Äî·Ä∫ Spin ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Ä´!</div>
    </div>

    <script>
        const BASE_URL = 'https://casino-opper.netlify.app';
        let userId;

        async function fetchData() {
            try {
                const response = await fetch(`${BASE_URL}/.netlify/functions/data`, { cache: 'no-store' });
                const data = await response.json();
                localStorage.setItem('offlineData', JSON.stringify(data));
                return data;
            } catch (e) {
                return JSON.parse(localStorage.getItem('offlineData') || '{}');
            }
        }

        async function updateData(updates) {
            if (navigator.onLine) {
                try {
                    const response = await fetch(`${BASE_URL}/.netlify/functions/data`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updates)
                    });
                    const data = await response.json();
                    localStorage.setItem('offlineData', JSON.stringify(data));
                    return data;
                } catch (e) {
                    console.error('Update failed:', e);
                }
            }
            let localData = JSON.parse(localStorage.getItem('offlineData') || '{}');
            localData = { ...localData, ...updates };
            localStorage.setItem('offlineData', JSON.stringify(localData));
            return localData;
        }

        async function updateUI() {
            const data = await fetchData();
            userId = localStorage.getItem('loggedInUser');
            if (!userId || !data.users || !data.users[userId]) {
                window.location.href = 'login.html';
                return;
            }
            if (!data.game || !data.game.adminStarted) {
                document.getElementById('slot-result').innerHTML = "‚è≥ Admin ·Äô·Äæ ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´...";
                return;
            }
            document.getElementById('balance').innerHTML = data.users[userId].balance || 0;

            let onlineCount = 0;
            Object.values(data.users || {}).forEach(user => {
                if (Date.now() - user.lastActive < 30000) onlineCount++;
            });
            document.getElementById('online-players').innerHTML = `Online Players: ${onlineCount}`;
            data.users[userId].lastActive = Date.now();
            data.users[userId].transactions = data.users[userId].transactions || [];
            data.users[userId].transactions.push({ type: 'game', game: 'slots', timestamp: Date.now() });
            await updateData({ users: data.users });
        }

        async function spin() {
            const data = await fetchData();
            if (!data.game || !data.game.adminStarted) {
                document.getElementById('slot-result').innerHTML = "‚è≥ Admin ·Äô·Äæ ·ÄÇ·Ä≠·Äô·Ä∫·Ä∏·ÄÖ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫ ·ÄÖ·Ä±·Ä¨·ÄÑ·Ä∑·Ä∫·Äï·Ä´...";
                return;
            }
            const bet = 100;
            if (!data.users[userId] || data.users[userId].balance < bet) {
                document.getElementById('slot-result').innerHTML = '·ÄÑ·ÄΩ·Ä±·Äô·Äú·ÄØ·Ä∂·Äú·Ä±·Ä¨·ÄÄ·Ä∫·Äï·Ä´!';
                return;
            }
            data.users[userId].balance -= bet;
            const result = Math.random() < 0.3 ? bet * 2 : 0;
            data.users[userId].balance += result;
            data.users[userId].totalWinnings = (data.users[userId].totalWinnings || 0) + result;
            data.users[userId].transactions.push({ type: 'bet', game: 'slots', amount: bet, timestamp: Date.now() });
            if (result > 0) data.users[userId].transactions.push({ type: 'win', game: 'slots', amount: result, timestamp: Date.now() });
            await updateData({ users: data.users });
            document.getElementById('slot-result').innerHTML = result > 0 ? `·Ä°·Äî·Ä≠·ÄØ·ÄÑ·Ä∫·Äõ: ${result} MMK!` : '·Ä°·Äõ·Äæ·ÄØ·Ä∂·Ä∏·Äï·Ä´!';
            updateUI();
        }

        window.onload = () => {
            updateUI();
            setInterval(updateUI, 1000);
        };
    </script>
</body>
</html>
